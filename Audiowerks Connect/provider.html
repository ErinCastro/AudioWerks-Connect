<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Provider Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Modern admin header and menu styles from admin.html */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: url('images/lights-sounds.png') center/cover no-repeat, rgba(255,255,255,0.7);
      background-blend-mode: lighten;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      backdrop-filter: blur(8px);
    }
    .logo-container img {
      height: 120px;
      cursor: pointer;
    }
    .logo-container a {
      display: inline-block;
    }
    .header-center {
      text-align: center;
      flex: 1;
    }
    .header-center h1 {
      font-size: 64px;
      font-weight: bold;
      color: #0047AB;
      text-shadow: 2px 2px #ffffff;
    }
    .header-center p {
      font-size: 24px;
      color: #0047AB;
      text-shadow: 1px 1px #ffffff;
    }
    .header-icons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .header-icons i {
      font-size: 28px;
      color: #000;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .header-icons i:hover {
      transform: scale(1.2);
    }
    .menu-popup {
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      overflow: hidden;
      z-index: 1000;
      min-width: 200px;
      transition: all 0.3s ease;
    }
    .menu-popup a {
      display: block;
      padding: 10px 15px;
      color: #000;
      text-decoration: none;
      border-bottom: 1px solid #eee;
    }
    .menu-popup a:hover {
      background-color: #f0f0f0;
    }
    .menu-popup a:last-child {
      background-color: #191970;
      color: #fff;
      border-bottom: none;
      transition: background 0.3s ease, transform 0.2s;
    }
    .menu-popup a:last-child:hover {
      background-color: #000080;
      transform: scale(1.02);
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      color: #0047AB;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    .section {
      margin-bottom: 30px;
    }

    button {
      margin-top: 15px;
      padding: 12px 20px;
      background: #0047AB;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    .success {
      color: green;
      font-weight: bold;
      margin-top: 10px;
    }

    footer {
      background-color: #000;
      color: white;
      text-align: center;
      padding: 15px 10px;
      margin-top: 40px;
    }
    /* Modern card and table polish */
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.13);
      padding: 32px 28px 28px 28px;
      margin-bottom: 32px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .card h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #0047AB;
      margin-bottom: 18px;
      letter-spacing: 1px;
    }
    .card label {
      font-weight: 600;
      margin-top: 12px;
      margin-bottom: 4px;
      color: #1e5aa8;
    }
    .card input, .card textarea, .card select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #bccedf;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 12px;
      margin-top: 2px;
      background: #f8fafc;
      transition: border 0.2s;
    }
    .card input:focus, .card textarea:focus {
      border: 1.5px solid #0047AB;
      outline: none;
      background: #eaf1fb;
    }
    .card button {
      background: #0047AB;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(30,90,168,0.08);
    }
    .card button:hover {
      background: #191970;
      transform: translateY(-2px) scale(1.03);
    }
    .success {
      color: #1e7e34;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #f9f9fb;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 10px;
      text-align: left;
    }
    th {
      background: #eaf1fb;
      color: #0047AB;
      font-weight: 700;
      border-bottom: 2px solid #bccedf;
    }
    tr:nth-child(even) {
      background: #f4f7fa;
    }
    tr:hover {
      background: #e0eaff;
    }
    td button {
      margin-right: 6px;
      padding: 7px 16px;
      font-size: 0.95rem;
      border-radius: 6px;
    }
    @media (max-width: 900px) {
      .container {
        max-width: 98vw;
        padding: 0;
      }
      .card {
        max-width: 98vw;
        padding: 18px 2vw 18px 2vw;
      }
      table {
        font-size: 0.98rem;
      }
    }
    @media (max-width: 700px) {
      .card {
        padding: 12px 2vw 12px 2vw;
        margin-bottom: 18px;
      }
      .card h2 {
        font-size: 1.1rem;
      }
      .card h3 {
        font-size: 1rem;
      }
      th, td {
        padding: 7px 2px;
        font-size: 0.95rem;
      }
      .container {
        padding: 0;
      }
      .header-center h1 {
        font-size: 2rem;
      }
      .header-center p {
        font-size: 1rem;
      }
    }
    @media (max-width: 480px) {
      .card {
        padding: 8px 1vw 8px 1vw;
        border-radius: 10px;
      }
      .card h2, .card h3 {
        font-size: 1rem;
      }
      th, td {
        padding: 5px 1px;
        font-size: 0.9rem;
      }
      .logo-container img {
        height: 60px;
      }
      .header-center h1 {
        font-size: 1.2rem;
      }
      .header-center p {
        font-size: 0.8rem;
      }
      .menu-popup {
        min-width: 120px;
      }
    }
    /* Make tables horizontally scrollable on small screens */
    @media (max-width: 700px) {
      .card table {
        display: block;
        overflow-x: auto;
        width: 100%;
      }
      .card table thead, .card table tbody, .card table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }
    }
    /* Section spacing */
    .section {
      margin-bottom: 28px;
    }
    @media (max-width: 900px) {
      header {
        padding: 10px;
      }
      .logo-container img {
        height: 80px;
      }
      .header-center h1 {
        font-size: 2.2rem;
      }
      .header-center p {
        font-size: 1.1rem;
      }
    }
    @media (max-width: 700px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 8px 2vw;
      }
      .logo-container img {
        height: 60px;
      }
      .header-center h1 {
        font-size: 1.3rem;
      }
      .header-center p {
        font-size: 0.9rem;
      }
      .header-icons {
        flex-direction: row;
        gap: 10px;
        margin-top: 8px;
      }
      .menu-popup {
        min-width: 120px;
        right: 10px;
        top: 60px;
      }
    }
    @media (max-width: 480px) {
      header {
        padding: 4px 1vw;
      }
      .logo-container img {
        height: 40px;
      }
      .header-center h1 {
        font-size: 1rem;
      }
      .header-center p {
        font-size: 0.7rem;
      }
      .menu-popup {
        min-width: 90px;
        right: 4px;
        top: 44px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo-container">
    <a href="admin.html"><img src="logo.png" alt="AudioWerks Logo, click to go home" /></a>
  </div>
  <div class="header-center">
    <h1>Audiowerks</h1>
    <p>Lights and Sounds</p>
  </div>
  <div class="header-icons">
    <i class="fas fa-bars" aria-label="Menu" tabindex="0" onclick="toggleMenu(this)"></i>
  </div>
  <nav class="menu-popup" id="menuPopup" aria-label="Admin Navigation">
    <a href="admin.html">Dashboard</a>
    <a href="adminchat.html">Chat</a>
    <a href="provider.html">Profile</a>
    <a href="login.html" onclick="logout()">Logout</a>
  </nav>
</header>

<div class="card">
  <h3>Services</h3>
  <table>
    <thead>
      <tr>
        <th>Service</th>
        <th>Price</th>
        <th>Available Units</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="servicesTbody"></tbody>
  </table>
  <div id="addServiceForm" style="margin-top:10px;">
    <input type="text" id="serviceName" placeholder="Service name" style="margin-right:5px;"/>
    <input type="number" id="servicePrice" placeholder="Service price" style="margin-right:5px; width:100px;"/>
    <input type="number" id="serviceAvailable" placeholder="Available units" style="margin-right:5px; width:100px;"/>
    <button id="addServiceBtn">Add Service</button>
  </div>
</div>
<div class="card">
  <h3>Bundles</h3>
  <table>
    <thead>
      <tr>
        <th>Bundle</th>
        <th>Price</th>
        <th>Included Services</th>
        <th>Available Units</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="bundlesTbody"></tbody>
  </table>
  <div id="addBundleForm" style="margin-top:10px;">
    <input type="text" id="bundleName" placeholder="Bundle name" style="margin-right:5px;"/>
    <input type="number" id="bundlePrice" placeholder="Bundle price" style="margin-right:5px; width:100px;"/>
    <input type="text" id="bundleServicesInput" placeholder="Included services (comma separated)" style="margin-right:5px; width:180px;"/>
    <input type="number" id="bundleAvailable" placeholder="Available units" style="margin-right:5px; width:100px;"/>
    <button id="addBundleBtn">Add Bundle</button>
  </div>
</div>
<div class="card">
  <h3>Bookings</h3>
  <table>
    <thead>
      <tr>
        <th>Customer</th>
        <th>Product</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>Quantity</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="providerBookingsTbody"></tbody>
  </table>
  <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
    <h4 style="margin: 0 0 10px 0; color: #0047AB;">🧪 Testing Tools</h4>
    <button onclick="testBundleCancellation()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
      Test Bundle Cancellation
    </button>
    <small style="color: #666;">This will create a test booking for 2 units of a bundle and then you can cancel it to test the restoration.</small>
  </div>
</div>

<footer>
  <p>&copy; 2025 AudioWerks. All rights reserved.</p>
</footer>

<script>
  function toggleMenu(btn) {
    const menu = document.getElementById('menuPopup');
    const bars = document.querySelector('.fa-bars');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    bars.classList.toggle('active');
  }
  window.addEventListener('click', function (e) {
    const menu = document.getElementById('menuPopup');
    const button = document.querySelector('.fa-bars');
    if (!menu.contains(e.target) && e.target !== button) {
      menu.style.display = 'none';
      button.classList.remove('active');
    }
  });
  function logout() {
    alert("Logged out.");
  }

  function saveService() {
    const name = document.getElementById('serviceName').value;
    const price = document.getElementById('servicePrice').value;
    if (name && price) {
      // Simulate saving
      document.getElementById('serviceSuccess').textContent = "Service information updated successfully!";
    }
  }

  function saveEquipment() {
    const equipment = document.getElementById('equipmentList').value;
    if (equipment) {
      // Simulate saving
      document.getElementById('equipmentSuccess').textContent = "Equipment list updated successfully!";
    }
  }

  function savePortfolio() {
    const files = document.getElementById('portfolioUpload').files;
    if (files.length > 0) {
      document.getElementById('portfolioSuccess').textContent = "Portfolio updated successfully!";
    }
  }
</script>
<!-- Place these scripts before any custom JS -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="firebase-config-new.js"></script>
<script src="firebase-backend-new.js"></script>
<script>
// Services logic
async function loadServices() {
  const coreServices = [
    'Lights & Sounds',
    'Led Wall',
    'Stage',
    'Mood Light',
    'String Lights',
    'Low Lying'
  ];
  const services = await window.getAllServices() || {};
  const servicesTbody = document.getElementById('servicesTbody');
  servicesTbody.innerHTML = '';
  // Show core services first
  coreServices.forEach(coreName => {
    const foundEntry = Object.entries(services).find(([id, s]) => s.name && s.name.toLowerCase() === coreName.toLowerCase());
    if (foundEntry) {
      const [id, s] = foundEntry;
      const available = parseInt(s.available) || 0;
      const isSoldOut = available === 0;
      
      const tr = document.createElement('tr');
      tr.style.opacity = isSoldOut ? '0.6' : '1';
      tr.innerHTML = `
        <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">${s.name}</td>
        <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">₱${s.price || ''}</td>
        <td style="${isSoldOut ? 'color:#dc3545;font-weight:bold;' : ''}">${available}</td>
        <td><button class="edit-service" data-id="${id}">Edit</button></td>
      `;
      servicesTbody.appendChild(tr);
    } else {
      // Not configured yet
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${coreName}</td><td colspan="2" style="color:#b0b6be;">Not configured</td><td><button class="add-core-service" data-name="${coreName}">Add</button></td>`;
      servicesTbody.appendChild(tr);
    }
  });
      // Show any extra (custom) services
    Object.entries(services).forEach(([id, s]) => {
      if (!coreServices.some(core => core.toLowerCase() === (s.name||'').toLowerCase())) {
        const available = parseInt(s.available) || 0;
        const isSoldOut = available === 0;
        
        const tr = document.createElement('tr');
        tr.style.opacity = isSoldOut ? '0.6' : '1';
        tr.innerHTML = `
          <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">${s.name || ''}</td>
          <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">₱${s.price || ''}</td>
          <td style="${isSoldOut ? 'color:#dc3545;font-weight:bold;' : ''}">${available}</td>
          <td><button class="edit-service" data-id="${id}">Edit</button> <button class="del-service" data-id="${id}">Delete</button></td>
        `;
        servicesTbody.appendChild(tr);
      }
    });
}
// Bundles logic
async function loadBundles() {
  const bundles = await window.getAllBundles() || {};
  const services = await window.getAllServices() || {};
  // Populate bundles table
  const bundlesTbody = document.getElementById('bundlesTbody');
  bundlesTbody.innerHTML = '';
  Object.entries(bundles).forEach(([id, b]) => {
    const available = parseInt(b.available) || 0;
    const isSoldOut = available === 0;
    
    const tr = document.createElement('tr');
    tr.style.opacity = isSoldOut ? '0.6' : '1';
    tr.innerHTML = `
      <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">${b.name || ''}</td>
      <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">₱${b.price || ''}</td>
      <td style="${isSoldOut ? 'color:#b0b6be;' : ''}">${(b.services||[]).join(', ')}</td>
      <td style="${isSoldOut ? 'color:#dc3545;font-weight:bold;' : ''}">${available}</td>
      <td><button class="edit-bundle" data-id="${id}">Edit</button> <button class="del-bundle" data-id="${id}">Delete</button></td>
    `;
    bundlesTbody.appendChild(tr);
  });
  // Populate services checkboxes for bundle creation
  const bundleServicesSelect = document.getElementById('bundleServicesSelect');
  if (bundleServicesSelect) {
    bundleServicesSelect.innerHTML = '';
    Object.values(services).forEach(s => {
      const label = document.createElement('label');
      label.style.marginRight = '8px';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = s.name;
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + s.name));
      bundleServicesSelect.appendChild(label);
    });
  }
}
async function loadAll() {
  await loadServices();
  await loadBundles();
}
document.addEventListener('DOMContentLoaded', loadAll);
// --- Add Service and Bundle Firebase Logic ---
document.addEventListener('click', async function(e) {
  // Add service
  if (e.target && e.target.id === 'addServiceBtn') {
    const name = document.getElementById('serviceName').value.trim();
    const price = document.getElementById('servicePrice').value.trim();
    const available = document.getElementById('serviceAvailable').value.trim();
    const imageInput = document.getElementById('serviceImage');
    let imageUrl = '';
    if (!name || !price || available === '') return;
    try {
      if (!firebase.auth().currentUser) {
        alert('You must be logged in to add a service.');
        return;
      }
      if (imageInput && imageInput.files && imageInput.files[0]) {
        // Upload image to Firebase Storage
        const file = imageInput.files[0];
        const storageRef = firebase.storage().ref('service-images/' + Date.now() + '_' + file.name);
        await storageRef.put(file);
        imageUrl = await storageRef.getDownloadURL();
      }
      await window.addService({ name, price, available, image: imageUrl });
      document.getElementById('serviceName').value = '';
      document.getElementById('servicePrice').value = '';
      document.getElementById('serviceAvailable').value = '';
      if (imageInput) imageInput.value = '';
      loadServices();
      loadBundles();
    } catch (err) {
      alert('Failed to add service: ' + (err && err.message ? err.message : err));
    }
  }
  // Add core service from 'Not configured' row
  if (e.target && e.target.classList.contains('add-core-service')) {
    const name = e.target.getAttribute('data-name');
    const price = prompt(`Enter price for ${name}:`);
    if (price === null) return;
    const available = prompt(`Enter available units for ${name}:`);
    if (available === null) return;
    try {
      await window.addService({ name, price, available });
      loadServices();
      loadBundles();
    } catch (err) {
      alert('Failed to add core service: ' + err.message);
    }
  }
  // Edit service
  if (e.target && e.target.classList.contains('edit-service')) {
    const id = e.target.getAttribute('data-id');
    const services = await window.getAllServices() || {};
    const service = services[id];
    if (!service) return;
    const tr = e.target.closest('tr');
    // Replace row with edit form
    tr.innerHTML = `
      <td colspan="4">
        <form id="editServiceForm" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
          <input type="text" id="editServiceName" value="${service.name || ''}" placeholder="Service name" style="width:140px;" required />
          <input type="number" id="editServicePrice" value="${service.price || ''}" placeholder="Service price" style="width:100px;" required />
          <input type="number" id="editServiceAvailable" value="${service.available !== undefined ? service.available : ''}" placeholder="Available units" style="width:100px;" required />
          <div style="display:flex; flex-direction:column; align-items:center;">
            <img src="${service.image || 'https://placehold.co/100x70'}" alt="Current Image" style="max-width:100px; max-height:70px; margin-bottom:4px; border-radius:6px;" />
            <input type="file" id="editServiceImage" accept="image/*" />
          </div>
          <button type="submit" style="background:#0047AB; color:#fff;">Save</button>
          <button type="button" id="cancelEditBtn" style="background:#ccc; color:#222;">Cancel</button>
        </form>
      </td>
    `;
    // Cancel button logic
    tr.querySelector('#cancelEditBtn').onclick = function() { loadServices(); };
    // Save logic
    tr.querySelector('#editServiceForm').onsubmit = async function(ev) {
      ev.preventDefault();
      const newName = tr.querySelector('#editServiceName').value.trim();
      const newPrice = tr.querySelector('#editServicePrice').value.trim();
      const newAvailable = tr.querySelector('#editServiceAvailable').value.trim();
      const imageInput = tr.querySelector('#editServiceImage');
      let newImageUrl = service.image || '';
      if (imageInput && imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        const storageRef = firebase.storage().ref('service-images/' + Date.now() + '_' + file.name);
        await storageRef.put(file);
        newImageUrl = await storageRef.getDownloadURL();
      }
      await window.updateService(id, { name: newName, price: newPrice, available: newAvailable, image: newImageUrl });
      loadServices();
      loadBundles();
    };
    return;
  }
  // Delete service (only for non-core)
  if (e.target && e.target.classList.contains('del-service')) {
    const id = e.target.getAttribute('data-id');
    const services = await window.getAllServices() || {};
    const service = services[id];
    const coreServices = [
      'Lights & Sounds',
      'Led Wall',
      'Stage',
      'Mood Light',
      'String Lights',
      'Low Lying'
    ];
    if (coreServices.some(core => core.toLowerCase() === (service.name||'').toLowerCase())) {
      alert('You cannot delete a core service.');
      return;
    }
    if (confirm('Delete this service?')) {
      await window.deleteService(id);
      loadServices();
      loadBundles();
    }
  }
  // Add bundle
  if (e.target && e.target.id === 'addBundleBtn') {
    const name = document.getElementById('bundleName').value.trim();
    const price = document.getElementById('bundlePrice').value.trim();
    const servicesInput = document.getElementById('bundleServicesInput').value.trim();
    const available = document.getElementById('bundleAvailable').value.trim();
    const services = servicesInput ? servicesInput.split(',').map(s => s.trim()).filter(Boolean) : [];
    if (!name || !price || !services.length || available === '') {
      alert('Please enter a bundle name, price, available units, and at least one included service.');
      return;
    }
    try {
      if (!firebase.auth().currentUser) {
        alert('You must be logged in to add a bundle.');
        return;
      }
      await window.addBundle({ name, price, services, available });
      document.getElementById('bundleName').value = '';
      document.getElementById('bundlePrice').value = '';
      document.getElementById('bundleServicesInput').value = '';
      document.getElementById('bundleAvailable').value = '';
      loadBundles();
    } catch (err) {
      alert('Failed to add bundle: ' + (err && err.message ? err.message : err));
    }
  }
  // Edit bundle
  if (e.target && e.target.classList.contains('edit-bundle')) {
    const id = e.target.getAttribute('data-id');
    const bundles = await window.getAllBundles() || {};
    const bundle = bundles[id];
    if (!bundle) return;
    const tr = e.target.closest('tr');
    // Replace row with edit form
    tr.innerHTML = `
      <td colspan="5">
        <form id="editBundleForm" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
          <input type="text" id="editBundleName" value="${bundle.name || ''}" placeholder="Bundle name" style="width:140px;" required />
          <input type="number" id="editBundlePrice" value="${bundle.price || ''}" placeholder="Bundle price" style="width:100px;" required />
          <input type="text" id="editBundleServices" value="${(bundle.services||[]).join(', ')}" placeholder="Included services (comma separated)" style="width:180px;" required />
          <input type="number" id="editBundleAvailable" value="${bundle.available !== undefined ? bundle.available : ''}" placeholder="Available units" style="width:100px;" required />
          <button type="submit" style="background:#0047AB; color:#fff;">Save</button>
          <button type="button" id="cancelEditBundleBtn" style="background:#ccc; color:#222;">Cancel</button>
        </form>
      </td>
    `;
    // Cancel button logic
    tr.querySelector('#cancelEditBundleBtn').onclick = function() { loadBundles(); };
    // Save logic
    tr.querySelector('#editBundleForm').onsubmit = async function(ev) {
      ev.preventDefault();
      const newName = tr.querySelector('#editBundleName').value.trim();
      const newPrice = tr.querySelector('#editBundlePrice').value.trim();
      const newServices = tr.querySelector('#editBundleServices').value.trim();
      const newAvailable = tr.querySelector('#editBundleAvailable').value.trim();
      await window.updateBundle(id, { name: newName, price: newPrice, services: newServices.split(',').map(s => s.trim()).filter(Boolean), available: newAvailable });
      loadBundles();
    };
    return;
  }
  // Delete bundle
  if (e.target && e.target.classList.contains('del-bundle')) {
    const id = e.target.getAttribute('data-id');
    if (confirm('Delete this bundle?')) {
      await window.deleteBundle(id);
      loadBundles();
    }
  }
});

// Add this function to provider.html for booking cancellation with stock restoration
async function cancelBooking(bookingId) {
  try {
    console.log('=== CANCELLING BOOKING ===');
    console.log('Booking ID:', bookingId);
    
    // 1. Get booking details
    const bookingSnap = await firebase.database().ref('bookings/' + bookingId).once('value');
    const booking = bookingSnap.val();
    if (!booking) {
      console.error('❌ Booking not found:', bookingId);
      alert('Booking not found!');
      return;
    }
    
    console.log('📋 Booking details:', booking);
    console.log('Product ID:', booking.productId);
    console.log('Product Type:', booking.productType);
    console.log('Quantity:', booking.quantity);

    // Check if booking has required fields
    if (!booking.productId) {
      console.error('❌ Booking missing productId field');
      alert('Booking is missing product ID. Cannot restore stock.');
      return;
    }

    // 2. Determine if it's a product or bundle
    const isBundle = booking.productType === 'bundle';
    const refPath = isBundle ? 'bundles/' + booking.productId : 'services/' + booking.productId;
    console.log('🔍 Looking up product at path:', refPath);
    console.log('📦 Is Bundle:', isBundle);
    console.log('🆔 Product ID:', booking.productId);
    console.log('🏷️ Product Type:', booking.productType);

    // 3. Get the current available units
    const prodSnap = await firebase.database().ref(refPath).once('value');
    const prod = prodSnap.val();
    if (!prod) {
      console.error('❌ Product not found at path:', refPath);
      alert('Product not found in database. Cannot restore stock.');
      return;
    }
    
    console.log('📦 Current product data:', prod);
    console.log('📊 Current available units:', prod.available);
    console.log('📈 Cancelled quantity:', booking.quantity);

    // 4. Increment available units by the cancelled quantity
    const currentAvailable = parseInt(prod.available) || 0;
    const cancelledQuantity = parseInt(booking.quantity) || 1;
    const newAvailable = currentAvailable + cancelledQuantity;
    
    console.log('🧮 Calculation:', currentAvailable, '+', cancelledQuantity, '=', newAvailable);
    
    await firebase.database().ref(refPath + '/available').set(newAvailable);
    console.log('✅ Available units updated in Firebase to:', newAvailable);

    // 5. Mark the booking as cancelled
    await firebase.database().ref('bookings/' + bookingId).update({ status: 'Cancelled' });
    console.log('✅ Booking status updated to Cancelled');

    alert('✅ Booking cancelled and stock updated! New available units: ' + newAvailable);
    
    // Refresh the bookings table
    loadProviderBookings();
    
    console.log('=== CANCELLATION COMPLETE ===');
    
  } catch (error) {
    console.error('❌ Error cancelling booking:', error);
    alert('❌ Error cancelling booking: ' + error.message);
  }
}
// Example usage: call cancelBooking(bookingId) when a booking is cancelled from provider.html

// Load and render bookings for provider
async function loadProviderBookings() {
  const bookingsSnap = await firebase.database().ref('bookings').once('value');
  const bookings = bookingsSnap.val() || {};
  const tbody = document.getElementById('providerBookingsTbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  Object.entries(bookings).forEach(([id, b]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${b.customerName || b.customer || ''}</td>
      <td>${b.productName || ''}</td>
      <td>${b.startDate || ''}</td>
      <td>${b.endDate || ''}</td>
      <td>${b.quantity || 1}</td>
      <td>${b.status || ''}</td>
      <td>
        <button onclick="cancelBooking('${id}')" ${b.status === 'Cancelled' ? 'disabled' : ''}>Cancel</button>
        <button onclick="debugBooking('${id}')" style="background: #ffc107; margin-left: 5px;">Debug</button>
        ${b.productType === 'bundle' ? `<button onclick="testBundleCancellation()" style="background: #28a745; margin-left: 5px;">Test Bundle</button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Debug function to inspect booking data
async function debugBooking(bookingId) {
  try {
    const bookingSnap = await firebase.database().ref('bookings/' + bookingId).once('value');
    const booking = bookingSnap.val();
    
    console.log('🔍 DEBUGGING BOOKING:', bookingId);
    console.log('Full booking data:', booking);
    
    let debugInfo = '📋 Booking Debug Info:\n\n';
    debugInfo += `ID: ${bookingId}\n`;
    debugInfo += `Product Name: ${booking.productName || 'N/A'}\n`;
    debugInfo += `Product ID: ${booking.productId || 'MISSING!'}\n`;
    debugInfo += `Product Type: ${booking.productType || 'MISSING!'}\n`;
    debugInfo += `Quantity: ${booking.quantity || 'N/A'}\n`;
    debugInfo += `Status: ${booking.status || 'N/A'}\n`;
    debugInfo += `Customer: ${booking.customerName || booking.customer || 'N/A'}\n`;
    
    if (booking.productId && booking.productType) {
      const refPath = booking.productType === 'bundle' ? 'bundles/' + booking.productId : 'services/' + booking.productId;
      const prodSnap = await firebase.database().ref(refPath).once('value');
      const prod = prodSnap.val();
      
      if (prod) {
        debugInfo += `\n📦 Product found at: ${refPath}\n`;
        debugInfo += `Current available units: ${prod.available || 'N/A'}\n`;
        debugInfo += `Product name: ${prod.name || 'N/A'}\n`;
        
        // Add specific bundle info
        if (booking.productType === 'bundle') {
          debugInfo += `\n📋 Bundle Details:\n`;
          debugInfo += `Services included: ${(prod.services || []).join(', ')}\n`;
          debugInfo += `Bundle price: ₱${prod.price || 'N/A'}\n`;
        }
      } else {
        debugInfo += `\n❌ Product NOT found at: ${refPath}\n`;
      }
    } else {
      debugInfo += '\n❌ Cannot look up product - missing productId or productType\n';
    }
    
    alert(debugInfo);
    
  } catch (error) {
    console.error('Error debugging booking:', error);
    alert('Error debugging booking: ' + error.message);
  }
}

// Test function to manually test bundle cancellation
async function testBundleCancellation() {
  try {
    console.log('🧪 TESTING BUNDLE CANCELLATION');
    
    // Get all bundles
    const bundlesSnap = await firebase.database().ref('bundles').once('value');
    const bundles = bundlesSnap.val();
    
    if (!bundles || Object.keys(bundles).length === 0) {
      alert('❌ No bundles found in database');
      return;
    }
    
    console.log('📦 Available bundles:', bundles);
    
    // Find Eventmaster Trio or any bundle
    let targetBundle = null;
    let targetBundleId = null;
    
    Object.entries(bundles).forEach(([id, bundle]) => {
      if (bundle.name && bundle.name.toLowerCase().includes('eventmaster')) {
        targetBundle = bundle;
        targetBundleId = id;
      }
    });
    
    if (!targetBundle) {
      // Use the first bundle if Eventmaster Trio not found
      const firstBundle = Object.entries(bundles)[0];
      targetBundleId = firstBundle[0];
      targetBundle = firstBundle[1];
    }
    
    console.log('🎯 Testing with bundle:', targetBundle.name, 'ID:', targetBundleId);
    
    // Create a test booking
    const testBookingData = {
      productName: targetBundle.name,
      productId: targetBundleId,
      productType: 'bundle',
      quantity: 2,
      status: 'Pending',
      customer: 'test@example.com',
      customerName: 'Test User',
      startDate: '2024-01-15',
      endDate: '2024-01-16',
      timestamp: new Date().toISOString()
    };
    
    // Save test booking
    const bookingRef = await firebase.database().ref('bookings').push(testBookingData);
    const bookingId = bookingRef.key;
    
    console.log('✅ Test booking created with ID:', bookingId);
    
    // Decrement bundle available units
    const currentAvailable = parseInt(targetBundle.available) || 0;
    const newAvailable = Math.max(0, currentAvailable - 2);
    await firebase.database().ref(`bundles/${targetBundleId}/available`).set(newAvailable);
    
    console.log('📊 Bundle available units decremented from', currentAvailable, 'to', newAvailable);
    
    alert(`🧪 Test setup complete!\n\nBundle: ${targetBundle.name}\nAvailable units: ${newAvailable}\nTest booking ID: ${bookingId}\n\nNow try cancelling this booking to test the restoration.`);
    
  } catch (error) {
    console.error('Error in test setup:', error);
    alert('Error setting up test: ' + error.message);
  }
}
document.addEventListener('DOMContentLoaded', loadProviderBookings);
</script>

</body>
</html>
