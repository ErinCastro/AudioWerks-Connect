<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio - Audiowerks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="floating-chat.css" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #fff;
            color: #002244;
            margin: 0;
        }
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: url('images/lights-sounds.png') center/cover no-repeat, rgba(255,255,255,0.7);
            background-blend-mode: lighten;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        }
        .logo-container img {
            height: 70px;
            cursor: pointer;
        }
        .logo-container a {
            display: inline-block;
        }
        .header-center {
            text-align: center;
            flex: 1;
        }
        .header-icons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .header-icons i {
            font-size: 28px;
            color: #000;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .header-icons i:hover {
            transform: scale(1.2);
        }
        .menu-popup {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            z-index: 1000;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        .menu-popup a {
            display: block;
            padding: 10px 15px;
            color: #000;
            text-decoration: none;
            border-bottom: 1px solid #eee;
        }
        .menu-popup a:hover {
            background-color: #f0f0f0;
        }
        .menu-popup a:last-child {
            background-color: #191970;
            color: #fff;
            border-bottom: none;
            transition: background 0.3s ease, transform 0.2s;
        }
        .menu-popup a:last-child:hover {
            background-color: #000080;
            transform: scale(1.02);
        }
        .fa-bars {
            color: #000;
            transition: transform 0.3s;
        }
        .fa-bars.active {
            transform: rotate(90deg);
        }
        .section-bar {
            background: #002244;
            color: #fff;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            padding: 10px 0 8px 0;
            margin-top: 32px;
            margin-bottom: 0;
        }
        .divider {
            border: none;
            border-top: 5px solid #002244;
            margin: 0 0 32px 0;
            width: 100%;
        }
        .about-content {
            display: flex;
            align-items: flex-start;
            gap: 40px;
            max-width: 1100px;
            margin: 32px auto 0 auto;
            padding: 0 32px;
        }
        .about-img {
            width: 350px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            background: #e0e6ef;
        }
        .about-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .about-details h2 {
            font-size: 2rem;
            margin: 0 0 8px 0;
            color: #002244;
        }
        .about-details p {
            font-family: 'Georgia', serif;
            font-size: 1rem;
            margin: 0;
            line-height: 1.7;
            color: #222;
        }
        .partners-section {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 32px;
            text-align: center;
        }
        .partners-list {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin: 32px 0 0 0;
        }
        .partner {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .partner-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            background: #e0e6ef;
            margin-bottom: 10px;
            border: 4px solid #002244;
        }
        .partner-label {
            font-size: 1.1rem;
            color: #002244;
            font-weight: 600;
        }
        .gallery-section {
            max-width: 1100px;
            margin: 0 auto 40px auto;
            padding: 0 32px;
            text-align: center;
        }
        .gallery-list {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 32px;
            flex-wrap: wrap;
        }
        .gallery-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            background: #e0e6ef;
        }
        @media (max-width: 900px) {
            .about-content, .partners-list, .gallery-list {
                flex-direction: column;
                align-items: center;
            }
            .about-img, .gallery-img, .partner-img {
                width: 90vw;
                max-width: 350px;
            }
        }

        /* Additional chat styles to match homepage.html exactly */
        .pinned-modal .close-btn {
          position: absolute;
          top: 12px;
          right: 18px;
          background: none;
          border: none;
          font-size: 1.3rem;
          color: #002244;
          cursor: pointer;
          border-radius: 50%;
          padding: 2px 8px;
          transition: background 0.2s;
        }

        .pinned-modal .close-btn:hover {
          background: #e6eaf0;
        }

        .pinned-modal .pinned-list {
          display: flex;
          flex-direction: column;
          gap: 14px;
        }

        .pinned-modal .floating-chat-bubble {
          box-shadow: 0 2px 8px rgba(0,0,0,0.07);
          margin: 0;
        }

        .pinned-modal .msg-actions { 
          display: none !important; 
        }

        #floatingImageModalOverlay {
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.55);
          z-index: 5000;
          display: none; /* Initially hidden */
          align-items: center;
          justify-content: center;
        }

        #floatingImageModalOverlay.open {
          display: flex;
        }

        #floatingImageModal {
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.18);
          padding: 18px 18px 10px 18px;
          max-width: 96vw;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
          align-items: center;
          position: relative;
        }

        #floatingImageModal img {
          max-width: 80vw;
          max-height: 70vh;
          border-radius: 12px;
          box-shadow: 0 2px 12px rgba(0,0,0,0.13);
        }

        #floatingImageModal .close-btn {
          position: absolute;
          top: 8px;
          right: 12px;
          background: none;
          border: none;
          font-size: 1.7rem;
          color: #002244;
          cursor: pointer;
          border-radius: 50%;
          padding: 2px 8px;
          transition: background 0.2s;
        }

        #floatingImageModal .close-btn:hover {
          background: #e6eaf0;
        }

        #floatingPinnedModalContainer {
          position: fixed;
          top: 0; left: 0; width: 100%; height: 100%;
          z-index: 1002;
          display: none;
          justify-content: center;
          align-items: center;
          background: rgba(0,0,0,0.5);
        }

        #floatingPinnedModalContainer.show {
          display: flex;
        }


    </style>
</head>
<body>
    <header>
      <div class="logo-container">
        <a href="homepage.html"><img src="logo.png" alt="AudioWerks Logo, click to go home" /></a>
      </div>
      <div class="header-center">
        <h1 style="font-size: 2rem; font-weight: bold; color: #0047AB; margin: 0;">Audiowerks</h1>
        <p style="font-size: 1.1rem; color: #0047AB; margin: 0;">Lights and Sounds</p>
      </div>
      <div class="header-icons">
        <i class="fas fa-bars" aria-label="Menu" tabindex="0" onclick="toggleMenu(this)"></i>
      </div>
      <nav class="menu-popup" id="menuPopup" aria-label="Main Navigation">
        <a href="homepage.html">Home</a>
        <a href="portfolioo.html">Portfolio</a>
        <a href="Services.html">Book Here</a>
        <a href="User.html">User Profile</a>
        <a href="availability.html">Equipment</a>
        <a href="feedback.html">Feedback Dashboard</a>
        <a href="login.html" onclick="logout()">Logout</a>
      </nav>
    </header>
    <div class="section-bar" id="about">About Us</div>
    <hr class="divider">
    <div class="about-content">
        <img src="images/teams.png" alt="Team" class="about-img">
        <div class="about-details">
            <p>Established in 2010, audioWerks has over a decade of experience providing professional lights and sound services for events of all sizes. Whether it's weddings, corporate functions, concerts, or private parties, we deliver top-quality audio systems, innovative lighting designs, and reliable technical support to ensure your event shines.

                Based in Bulacan, audioWerks proudly serves clients across many areas, bringing our expertise and equipment wherever your event takes place.
                
                Our team of skilled technicians and designers understands that every occasion is unique. We work closely with clients to tailor our services to their vision, using industry-leading equipment and creative expertise to set the perfect mood.
                
                At audioWerks, we're passionate about turning ordinary events into extraordinary experiences.</p>
        </div>
    </div>
    <div class="section-bar" id="partners">Our Partners</div>
    <div class="partners-section">
        <div class="partners-list">
            <a href="https://www.facebook.com/share/1Hp3HcJFHK/?mibextid=wwXIfr" class="partner" target="_blank" rel="noopener" style="text-decoration:none;">
                <img src="images/eventually.png" alt="Event Partner 1" class="partner-img">
                <div class="partner-label">Eventually Yours</div>
            </a>
            <a href="https://www.facebook.com/share/16q6byDWKy/?mibextid=wwXIfr" class="partner" target="_blank" rel="noopener" style="text-decoration:none;">
                <img src="images/elegant.png" alt="Event Partner 2" class="partner-img">
                <div class="partner-label">Elegant Events</div>
            </a>
        </div>
    </div>
    <div class="section-bar" id="gallery">Gallery</div>
    <div class="gallery-section">
        <div class="gallery-list">
            <img src="images/a.jpg" alt="Gallery 1" class="gallery-img">
            <img src="images/b.jpg" alt="Gallery 2" class="gallery-img">
            <img src="images/c.jpg" alt="Gallery 3" class="gallery-img">
            <img src="images/d.jpg" alt="Gallery 4" class="gallery-img">
            <img src="images/e.jpg" alt="Gallery 5" class="gallery-img">
            <img src="images/f.jpg" alt="Gallery 6" class="gallery-img">
            <img src="images/g.jpg" alt="Gallery 7" class="gallery-img">
        </div>
    </div>
    <script>
      function toggleMenu(btn) {
        const menu = document.getElementById('menuPopup');
        const bars = document.querySelector('.fa-bars');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        bars.classList.toggle('active');
      }
      window.addEventListener('click', function (e) {
        const menu = document.getElementById('menuPopup');
        const button = document.querySelector('.fa-bars');
        if (!menu.contains(e.target) && e.target !== button) {
          menu.style.display = 'none';
          button.classList.remove('active');
        }
      });
      function logout() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "login.html";
      }
    </script>
  <!-- Floating Chat HTML (copied from homepage.html) -->
  <div class="floating-chat-head" id="floatingChatHead" title="Chat with us">
    <i class="fas fa-comment"></i>
    <span id="floatingChatNotif" style="display:none;position:absolute;top:2px;right:2px;background:#ff4444;color:#fff;font-size:0.85em;font-weight:700;min-width:20px;height:20px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;padding:0 6px;z-index:10;"></span>
  </div>
  <div class="floating-chat-popup" id="floatingChatPopup">
    <div class="floating-chat-popup-header">
      <span style="font-weight:700; font-size:1.1rem; letter-spacing:1px;">AudioWerks</span>
      <div class="floating-chat-header-right">
        <button class="floating-chat-call-btn" title="Call"><i class="fas fa-phone"></i></button>
      </div>
    </div>
    <div class="floating-chat-popup-body" id="floatingChatPopupBody"></div>
    <div class="floating-chat-popup-input">
      <div class="input-icons">
        <button class="input-btn" title="Attach"><i class="fas fa-paperclip"></i></button>
        <button class="input-btn" title="Pin"><i class="fas fa-thumbtack"></i></button>
        <button class="input-btn" title="Camera"><i class="fas fa-camera"></i></button>
      </div>
      <input type="text" id="floatingChatInput" placeholder="Type your message here..." />
      <button class="send-btn" id="floatingChatSendBtn" title="Send Message"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
  <div id="floatingPinnedModalContainer" style="display: none;"></div>
  <input type="file" id="floatingAttachmentInput" style="display:none" multiple />
  <input type="file" id="floatingCameraInput" accept="image/*" capture="environment" style="display:none" multiple />
  <div id="floatingImageModalOverlay">
    <div id="floatingImageModal">
      <button class="close-btn" title="Close">&times;</button>
      <img src="" alt="Preview" />
    </div>
  </div>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-storage-compat.js"></script>
  <script src="firebase-config-new.js"></script>
  <script>
    // --- CONFIG: Set your admin UID here ---
    const ADMIN_UID = 'FpAT19tEbYbIhbPbAi3TGNTutOT2NIptGOOVYPX6vP2kAo31JRNeMtl1'; // TODO: Replace with your actual admin UID
    // Floating chat head logic and backend (copied from homepage.html)
    let chatHead, chatPopup, chatInput, chatSendBtn, chatBody, db, currentUser, isAdminUser;

    function initializeChat() {
      try {
        chatHead = document.getElementById('floatingChatHead');
        chatPopup = document.getElementById('floatingChatPopup');
        chatInput = document.getElementById('floatingChatInput');
        chatSendBtn = document.getElementById('floatingChatSendBtn');
        chatBody = document.getElementById('floatingChatPopupBody');

        if (!chatHead || !chatPopup || !chatInput || !chatSendBtn || !chatBody) {
          console.warn('Chat elements not found, skipping chat initialization');
          return;
        }

        if (typeof firebase === 'undefined') {
          console.warn('Firebase not available for chat');
          chatBody.innerHTML = '<p>Chat temporarily unavailable.</p>';
          return;
        }

        // Test Firebase Storage availability
        try {
          const testRef = firebase.storage().ref('test');
          console.log('Firebase Storage is available');
        } catch (error) {
          console.error('Firebase Storage not available:', error);
        }

        db = firebase.database();
        currentUser = null;
        isAdminUser = false;

    function determineUserRole(user) {
      if (!user) return Promise.resolve();
      return firebase.database().ref('admins/' + user.uid).once('value').then(snap => {
        isAdminUser = !!snap.val();
            window.isAdminUser = isAdminUser;
          }).catch(error => {
            console.warn('Failed to determine user role:', error);
            isAdminUser = false;
            window.isAdminUser = false;
          });
        }

    firebase.auth().onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            determineUserRole(user).then(() => {
                db.ref('chat-messages').on('value', snap => {
                    const messages = snap.val() || {};
                    renderFloatingChatMessages(messages);
                    updateFloatingChatNotif(messages);
                });
            });
        } else {
            chatBody.innerHTML = '<p>Please log in to chat.</p>';
        }
    });

        // Chat event listeners
        chatHead.addEventListener('click', () => {
          chatPopup.classList.toggle('open');
          if (chatPopup.classList.contains('open')) {
            chatInput.focus();
            chatBody.scrollTop = chatBody.scrollHeight;
            updateDbReadReceipts();
          }
        });

        chatBody.addEventListener('scroll', function() {
          if (chatBody.scrollTop + chatBody.clientHeight >= chatBody.scrollHeight - 10) {
            updateDbReadReceipts();
          }
        });

        chatSendBtn.addEventListener('click', sendFloatingChatMsg);
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendFloatingChatMsg();
          }
        });

        // Initialize file upload handlers
        initializeFileUploads();

      } catch (error) {
        console.error('Chat initialization failed:', error);
      }
    }

    function updateDbReadReceipts() {
      if (!currentUser || !chatPopup.classList.contains('open') || !db) return;
      
      try {
        const myRole = isAdminUser ? 'admin' : 'client';
        const updates = {};
        const messagesRef = db.ref('chat-messages');

        messagesRef.once('value').then(snap => {
            const allMessages = snap.val() || {};
            Object.entries(allMessages).forEach(([msgId, msg]) => {
                const msgIsFromOther = msg.uid !== currentUser.uid;
                const iHaveNotRead = !(msg.readBy && msg.readBy[currentUser.uid]);

                if (msgIsFromOther && iHaveNotRead) {
                    updates[`${msgId}/readBy/${currentUser.uid}`] = true;
                    updates[`${msgId}/readBy/${myRole}`] = true;
                }
            });

            if (Object.keys(updates).length > 0) {
                messagesRef.update(updates);
            }
        }).catch(error => {
          console.warn('Failed to update read receipts:', error);
        });
      } catch (error) {
        console.warn('Read receipts update failed:', error);
      }
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function createFloatingBubble(text, side = 'right', options = {}) {
      const div = document.createElement('div');
      div.className = 'floating-chat-bubble ' + side + (options.pinned ? ' pinned' : '');
      
      // Handle text content (only if there's text and no attachment, or if it's a mixed message)
      if (text && text.trim()) {
        const textNode = document.createTextNode(text);
        div.appendChild(textNode);
      }
      
      // Handle attachments
      if (options.attachment) {
        console.log('Creating attachment element:', options.attachment);
        const attachment = options.attachment;
        
        if (attachment.type === 'image') {
          // Create image element
          const img = document.createElement('img');
          img.src = attachment.url;
          img.alt = attachment.name;
          img.style.maxWidth = '180px';
          img.style.maxHeight = '120px';
          img.style.display = 'block';
          img.style.margin = '8px 0';
          img.style.borderRadius = '10px';
          img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
          img.style.cursor = 'pointer';
          img.onclick = () => window.showFloatingImageModal?.(attachment.url);
          div.appendChild(img);
        } else {
          // Create file element
          const fileDiv = document.createElement('div');
          fileDiv.style.display = 'flex';
          fileDiv.style.alignItems = 'center';
          fileDiv.style.gap = '8px';
          fileDiv.style.margin = '8px 0';
          fileDiv.style.fontSize = '1.05rem';
          fileDiv.style.color = '#002244';
          fileDiv.style.background = '#f5f8fa';
          fileDiv.style.borderRadius = '8px';
          fileDiv.style.padding = '6px 12px';
          fileDiv.innerHTML = `<i class='fas fa-file'></i> <a href="${attachment.url}" download="${attachment.name}" target="_blank">${attachment.name}</a>`;
          div.appendChild(fileDiv);
        }
      }

      const ts = document.createElement('span');
      ts.className = 'msg-timestamp';
      ts.textContent = options.timestamp || formatTime(new Date());
      div.appendChild(ts);

      if (side === 'right') {
        const receipt = document.createElement('span');
        receipt.className = 'read-receipt';
        const otherPartyRole = isAdminUser ? 'client' : 'admin';
        if (options.readBy && options.readBy[otherPartyRole]) {
          receipt.innerHTML = '<i class="fas fa-eye"></i>';
        } else {
          receipt.textContent = '✓';
        }
        div.appendChild(receipt);
      }

      // Actions container
      const actions = document.createElement('span');
      actions.className = 'msg-actions';

      // Edit (only for right/sender messages)
      if (side === 'right') {
        const editBtn = document.createElement('button');
        editBtn.className = 'msg-action-btn';
        editBtn.title = 'Edit';
        editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
        editBtn.onclick = () => {
          // Find the text node (first text node, not attachment)
          let textNode = null;
          let originalText = '';
          for (let i = 0; i < div.childNodes.length; i++) {
            if (div.childNodes[i].nodeType === Node.TEXT_NODE && div.childNodes[i].textContent.trim()) {
              textNode = div.childNodes[i];
              originalText = div.childNodes[i].textContent;
              break;
            }
          }
          
          // If no text node found, create one
          if (!textNode) {
            textNode = document.createTextNode('');
            div.insertBefore(textNode, div.firstChild);
          }
          
          // Create input field
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'bubble-edit-input';
          input.value = originalText;
          input.style.width = '100%';
          input.style.marginBottom = '8px';
          
          // Create save and cancel buttons
          const saveBtn = document.createElement('button');
          saveBtn.className = 'msg-action-btn';
          saveBtn.title = 'Save';
          saveBtn.innerHTML = '<i class="fas fa-check"></i>';
          saveBtn.style.marginRight = '4px';
          
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'msg-action-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
          
          // Create button container
          const btnContainer = document.createElement('div');
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '4px';
          btnContainer.appendChild(saveBtn);
          btnContainer.appendChild(cancelBtn);
          
          // Replace text with input
          div.replaceChild(input, textNode);
          div.appendChild(btnContainer);
          
          // Focus input and select all text
          input.focus();
          input.select();
          
          // Save functionality
          saveBtn.onclick = () => {
            const newText = input.value.trim();
            if (newText && newText !== originalText && options.msgId && db) {
              db.ref('chat-messages/' + options.msgId).update({ text: newText });
            } else {
              // Restore original text
              div.replaceChild(textNode, input);
              div.removeChild(btnContainer);
            }
          };
          
          // Cancel functionality
          cancelBtn.onclick = () => {
            div.replaceChild(textNode, input);
            div.removeChild(btnContainer);
          };
          
          // Handle Enter and Escape keys
          input.onkeydown = (e) => {
            if (e.key === 'Enter') {
              saveBtn.click();
            } else if (e.key === 'Escape') {
              cancelBtn.click();
            }
          };
        };
        actions.appendChild(editBtn);
      }

      // Delete
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'msg-action-btn';
      deleteBtn.title = 'Delete';
      deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
      deleteBtn.onclick = () => {
        if (options.msgId && db) {
          db.ref('chat-messages/' + options.msgId).remove();
        }
      };
      actions.appendChild(deleteBtn);

      // React
      const reactBtn = document.createElement('button');
      reactBtn.className = 'msg-action-btn';
      reactBtn.title = 'React';
      reactBtn.innerHTML = '<i class="far fa-heart"></i>';
      reactBtn.onclick = () => {
        showReactionPicker(div, options.msgId);
      };
      actions.appendChild(reactBtn);

      // Pin (available for both admin and client users)
      const pinBtn = document.createElement('button');
      pinBtn.className = 'msg-action-btn';
      pinBtn.title = options.pinned ? 'Unpin' : 'Pin';
      pinBtn.innerHTML = '<i class="fas fa-thumbtack"></i>';
      pinBtn.onclick = () => {
        if (options.msgId && db && currentUser) {
          const newPinnedState = !options.pinned;
          console.log(`${currentUser.email} ${newPinnedState ? 'pinning' : 'unpinning'} message:`, options.msgId);
          db.ref('chat-messages/' + options.msgId).update({ 
            pinned: newPinnedState,
            pinnedBy: currentUser.uid,
            pinnedAt: firebase.database.ServerValue.TIMESTAMP
          });
        }
      };
      actions.appendChild(pinBtn);

      // Add reactions display if message has reactions
      if (options.reactions && Object.keys(options.reactions).length > 0) {
        const reactionsDiv = document.createElement('div');
        reactionsDiv.className = 'reactions';
        
        Object.entries(options.reactions).forEach(([emoji, users]) => {
          const reactionDiv = document.createElement('div');
          reactionDiv.className = 'reaction';
          if (users && users[currentUser.uid]) {
            reactionDiv.classList.add('active');
          }
          reactionDiv.innerHTML = `${emoji} <span class="count">${Object.keys(users || {}).length}</span>`;
          reactionDiv.onclick = () => {
            toggleReaction(options.msgId, emoji, currentUser.uid);
          };
          reactionsDiv.appendChild(reactionDiv);
        });
        
        div.appendChild(reactionsDiv);
      }

      div.appendChild(actions);

      return div;
    }

    function renderFloatingChatMessages(messages) {
      if (!chatBody) return;
      
      chatBody.innerHTML = '';
      if (!currentUser) return;

      try {
        Object.entries(messages)
          .filter(([msgId, msg]) => msg.uid === currentUser.uid || msg.recipientUid === currentUser.uid)
          .sort((a, b) => a[1].timestamp - b[1].timestamp)
          .forEach(([msgId, msg]) => {
            const side = (msg.uid === currentUser.uid) ? 'right' : 'left';
            const bubble = createFloatingBubble(msg.text, side, {
              msgId: msgId,
              timestamp: msg.timestamp ? formatTime(new Date(msg.timestamp)) : '',
              readBy: msg.readBy || {},
              pinned: msg.pinned || false,
              reactions: msg.reactions || {},
              attachment: msg.attachment || null
            });
            chatBody.appendChild(bubble);
          });
        chatBody.scrollTop = chatBody.scrollHeight;
      } catch (error) {
        console.warn('Failed to render chat messages:', error);
      }
    }

    function updateFloatingChatNotif(messages) {
      if (!currentUser) return;
      const notif = document.getElementById('floatingChatNotif');
      if (!notif) return;
      // Only count messages where current user is recipient and has not read
      const unreadCount = Object.values(messages).filter(msg =>
        msg.recipientUid === currentUser.uid && msg.uid !== currentUser.uid && (!msg.readBy || !msg.readBy[currentUser.uid])
      ).length;
      if (unreadCount > 0) {
        notif.textContent = unreadCount;
        notif.style.display = 'inline-flex';
      } else {
        notif.textContent = '';
        notif.style.display = 'none';
      }
    }

    function sendFloatingChatMsg() {
      const msgText = chatInput.value.trim();
      if (!msgText || !currentUser || !db) return;

      try {
        const role = isAdminUser ? 'admin' : 'client';
        const messageData = {
          text: msgText,
          uid: currentUser.uid,
          name: currentUser.displayName || currentUser.email,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          readBy: {
            [currentUser.uid]: true,
            [role]: true
          }
        };

        db.ref('chat-messages').push(messageData);
        chatInput.value = '';
      } catch (error) {
        console.warn('Failed to send message:', error);
      }
    }

    function initializeFileUploads() {
      console.log('initializeFileUploads called');
      try {
    const attachBtn = document.querySelector('.input-btn[title="Attach"]');
    const pinListBtn = document.querySelector('.input-btn[title="Pin"]');
    const cameraBtn = document.querySelector('.input-btn[title="Camera"]');
        console.log('Found buttons:', { attachBtn: !!attachBtn, pinListBtn: !!pinListBtn, cameraBtn: !!cameraBtn });
    const floatingAttachmentInput = document.getElementById('floatingAttachmentInput');
    const floatingCameraInput = document.getElementById('floatingCameraInput');
    const floatingPinnedModalContainer = document.getElementById('floatingPinnedModalContainer');

        if (attachBtn && floatingAttachmentInput) {
          attachBtn.addEventListener('click', function() {
            floatingAttachmentInput.value = '';
            floatingAttachmentInput.click();
          });
        }

        if (cameraBtn && floatingCameraInput) {
          cameraBtn.addEventListener('click', function() {
            floatingCameraInput.value = '';
            floatingCameraInput.click();
          });
        }

        if (floatingAttachmentInput) {
          floatingAttachmentInput.addEventListener('change', handleFileUpload);
        }

        if (floatingCameraInput) {
          floatingCameraInput.addEventListener('change', handleFileUpload);
        }

        if (pinListBtn && floatingPinnedModalContainer) {
          console.log('Pin button found, adding click listener');
          pinListBtn.addEventListener('click', function() {
            console.log('Pin button clicked!');
            try {
              showPinnedMessages(floatingPinnedModalContainer);
            } catch (error) {
              console.error('Error calling showPinnedMessages:', error);
              alert('Error: ' + error.message);
            }
          });
        } else {
          console.warn('Pin button or container not found:', { 
            pinListBtn: !!pinListBtn, 
            floatingPinnedModalContainer: !!floatingPinnedModalContainer 
          });
        }

        // Image modal functionality
    const floatingImageModalOverlay = document.getElementById('floatingImageModalOverlay');
    const floatingImageModal = document.getElementById('floatingImageModal');
        const floatingImageModalImg = floatingImageModal?.querySelector('img');
        const floatingImageModalClose = floatingImageModal?.querySelector('.close-btn');

        if (floatingImageModalClose) {
          floatingImageModalClose.onclick = () => {
            if (floatingImageModalOverlay) {
              floatingImageModalOverlay.classList.remove('open');
            }
          };
        }

        if (floatingImageModalOverlay) {
          floatingImageModalOverlay.onclick = e => {
            if (e.target === floatingImageModalOverlay) {
              floatingImageModalOverlay.classList.remove('open');
            }
          };
        }

        window.showFloatingImageModal = function(src) {
          if (floatingImageModalImg && floatingImageModalOverlay) {
        floatingImageModalImg.src = src;
        floatingImageModalOverlay.classList.add('open');
    }
        };

      } catch (error) {
        console.warn('File upload initialization failed:', error);
      }
    }

    function handleFileUpload(e) {
      console.log('handleFileUpload called with:', e.target.files);
      if (!e.target.files || e.target.files.length === 0) {
        console.log('No files selected');
        return;
      }
      if (!currentUser) {
        console.log('No current user');
        return;
      }
      if (!db) {
        console.log('No database connection');
        return;
      }
      if (typeof firebase === 'undefined') {
        console.log('Firebase not available');
        return;
      }
      
      try {
        Array.from(e.target.files).forEach(file => {
          // Show loading message
          const loadingDiv = createFloatingBubble('📎 Uploading ' + file.name + '...', 'right', { timestamp: formatTime(new Date()) });
          if (chatBody) {
            chatBody.appendChild(loadingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
          }
          
          // Create unique filename
          const timestamp = Date.now();
          const uniqueFileName = `${timestamp}_${file.name}`;
          console.log('Creating file reference for:', uniqueFileName);
          const fileRef = firebase.storage().ref(`chat-attachments/${uniqueFileName}`);
          console.log('File reference created:', fileRef);
          
          // Upload file to Firebase Storage
          console.log('Starting file upload...');
          fileRef.put(file).then(snapshot => {
            console.log('File uploaded successfully:', snapshot);
            // Get download URL
            return snapshot.ref.getDownloadURL();
          }).then(downloadURL => {
            console.log('Download URL obtained:', downloadURL);
            // Remove loading message
            if (chatBody && loadingDiv.parentNode) {
              chatBody.removeChild(loadingDiv);
            }
            
            // Create message data
            const role = isAdminUser ? 'admin' : 'client';
            const messageData = {
              text: '📎 ' + file.name, // Add filename as text for debugging
              uid: currentUser.uid,
              name: currentUser.displayName || currentUser.email,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              readBy: {
                [currentUser.uid]: true,
                [role]: true
              },
              attachment: {
                type: file.type.startsWith('image/') ? 'image' : 'file',
                name: file.name,
                size: file.size,
                url: downloadURL,
                fileName: uniqueFileName
              }
            };
            
            // Save to database
            console.log('Saving message data to database:', messageData);
            db.ref('chat-messages').push(messageData).then(() => {
              console.log('Message saved successfully to database');
            }).catch(error => {
              console.error('Failed to save message to database:', error);
            });
            
          }).catch(error => {
            console.error('File upload failed:', error);
            console.error('Error details:', {
              code: error.code,
              message: error.message,
              serverResponse: error.serverResponse
            });
            // Remove loading message and show error
            if (chatBody && loadingDiv.parentNode) {
              chatBody.removeChild(loadingDiv);
            }
            const errorDiv = createFloatingBubble('❌ Failed to upload ' + file.name + ': ' + error.message, 'right', { timestamp: formatTime(new Date()) });
            if (chatBody) {
              chatBody.appendChild(errorDiv);
              chatBody.scrollTop = chatBody.scrollHeight;
            }
          });
        });
      } catch (error) {
        console.warn('File upload failed:', error);
      }
    }

    function showPinnedMessages(container) {
      console.log('showPinnedMessages called with:', { container: !!container, db: !!db });
      try {
        if (!container || !db) {
          console.warn('Missing container or db:', { container: !!container, db: !!db });
          alert('Missing container or db: ' + JSON.stringify({ container: !!container, db: !!db }));
          return;
        }
        
        // Set up the modal container with proper styling
        console.log('Setting up modal container...');
        container.style.display = 'flex';
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.backgroundColor = 'rgba(0,0,0,0.5)';
        container.style.zIndex = '1002';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';
        
        // Show loading state
        console.log('Setting up loading state...');
        container.innerHTML = `
          <div class="pinned-modal">
            <button class="close-btn" title="Close">&times;</button>
            <h2>Pinned Messages</h2>
            <div class="pinned-list">
              <div style="color:#888;">Loading pinned messages...</div>
            </div>
          </div>
        `;
        
        console.log('Adding show class to container...');
        container.classList.add('show');
        console.log('Container classes after adding show:', container.className);
        console.log('Container display style:', container.style.display);
        
        // Fetch pinned messages from Firebase
        console.log('Fetching pinned messages from Firebase...');
        console.log('Current user:', currentUser ? { uid: currentUser.uid, email: currentUser.email } : 'Not logged in');
        console.log('Is admin user:', isAdminUser);
        
        db.ref('chat-messages').orderByChild('pinned').equalTo(true).once('value').then(snap => {
          const pinnedMessages = snap.val();
          console.log('Pinned messages fetched:', pinnedMessages);
          
          if (!pinnedMessages || Object.keys(pinnedMessages).length === 0) {
            container.innerHTML = `
              <div class="pinned-modal">
                <button class="close-btn" title="Close">&times;</button>
                <h2>Pinned Messages</h2>
                <div class="pinned-list">
                  <div style="color:#888;">No pinned messages.</div>
                </div>
              </div>
            `;
            return;
          }
          
          container.innerHTML = `
            <div class="pinned-modal">
              <button class="close-btn" title="Close">&times;</button>
              <h2>Pinned Messages</h2>
              <div class="pinned-list"></div>
            </div>
          `;
          
          const pinnedList = container.querySelector('.pinned-list');
          // Only show pinned messages that were pinned by the current user or the admin
          const filteredMessages = Object.entries(pinnedMessages).filter(([msgId, msg]) => {
            return (
              msg.pinned === true &&
              (msg.pinnedBy === currentUser.uid || msg.pinnedBy === ADMIN_UID)
            );
          });
          const sortedMessages = filteredMessages.sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
          
          sortedMessages.forEach(([msgId, msg]) => {
            const side = (msg.uid === currentUser.uid) ? 'right' : 'left';
            const bubble = createFloatingBubble(msg.text, side, {
              msgId: msgId,
              timestamp: msg.timestamp ? formatTime(new Date(msg.timestamp)) : '',
              readBy: msg.readBy || {},
              pinned: true,
              reactions: msg.reactions || {},
              attachment: msg.attachment || null
            });
            // Remove action buttons from pinned message display
            const actions = bubble.querySelector('.msg-actions');
            if (actions) actions.remove();
            // Add pin info if available
            if (msg.pinnedBy) {
              const pinInfo = document.createElement('div');
              pinInfo.style.fontSize = '0.8rem';
              pinInfo.style.color = '#0047AB';
              pinInfo.style.marginTop = '4px';
              pinInfo.style.fontStyle = 'italic';
              pinInfo.style.fontWeight = '500';
              if (msg.pinnedBy === currentUser.uid) {
                pinInfo.textContent = `📌 Pinned by you`;
              } else if (msg.pinnedBy === ADMIN_UID) {
                pinInfo.textContent = `📌 Pinned by admin`;
              } else {
                pinInfo.textContent = `📌 Pinned by someone`;
              }
              bubble.appendChild(pinInfo);
            }
            pinnedList.appendChild(bubble);
          });
          // Set up close functionality
          container.querySelector('.close-btn').onclick = () => {
            container.classList.remove('show');
            container.innerHTML = '';
          };
          container.onclick = e => { 
            if (e.target === container) {
              container.classList.remove('show');
              container.innerHTML = '';
            }
          };
        }).catch(error => {
          console.warn('Failed to fetch pinned messages:', error);
          container.innerHTML = `
            <div class="pinned-modal">
              <button class="close-btn" title="Close">&times;</button>
              <h2>Pinned Messages</h2>
              <div class="pinned-list">
                <div style="color:#d32f2f;">Failed to load pinned messages.</div>
              </div>
            </div>
          `;
        });
        
      } catch (error) {
        console.warn('Failed to show pinned messages:', error);
      }
    }

    // Reaction helper functions
    function showReactionPicker(bubble, msgId) {
      // Remove any existing reaction picker
      const existingPicker = document.querySelector('.reaction-picker');
      if (existingPicker) {
        existingPicker.remove();
      }

      const reactions = ['❤️', '👍', '👎', '😂', '😮', '😢', '😡', '🎉', '🔥', '💯'];
      
      const picker = document.createElement('div');
      picker.className = 'reaction-picker';
      
      reactions.forEach(emoji => {
        const option = document.createElement('button');
        option.className = 'reaction-option';
        option.textContent = emoji;
        option.onclick = () => {
          addReaction(msgId, emoji, currentUser.uid);
          picker.remove();
        };
        picker.appendChild(option);
      });
      
      bubble.appendChild(picker);
      
      // Show picker
      setTimeout(() => picker.classList.add('show'), 10);
      
      // Close picker when clicking outside
      const closePicker = (e) => {
        if (!picker.contains(e.target) && !bubble.querySelector('.msg-action-btn').contains(e.target)) {
          picker.remove();
          document.removeEventListener('click', closePicker);
        }
      };
      
      setTimeout(() => document.addEventListener('click', closePicker), 100);
    }

    function addReaction(msgId, emoji, userId) {
      if (!db || !msgId) return;
      
      const reactionRef = db.ref(`chat-messages/${msgId}/reactions/${emoji}/${userId}`);
      reactionRef.set(true);
    }

    function toggleReaction(msgId, emoji, userId) {
      if (!db || !msgId) return;
      
      const reactionRef = db.ref(`chat-messages/${msgId}/reactions/${emoji}/${userId}`);
      reactionRef.once('value').then(snap => {
        if (snap.val()) {
          // Remove reaction
          reactionRef.remove();
        } else {
          // Add reaction
          reactionRef.set(true);
        }
      });
    }

    // Initialize chat when DOM is loaded
    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing chat...');
      initializeChat();
      
      // Test Firebase Storage
      setTimeout(() => {
        console.log('Testing Firebase Storage...');
        if (typeof firebase !== 'undefined' && firebase.storage) {
          try {
            const testRef = firebase.storage().ref('test-file.txt');
            const testBlob = new Blob(['test content'], { type: 'text/plain' });
            testRef.put(testBlob).then(() => {
              console.log('Firebase Storage test successful');
              return testRef.getDownloadURL();
            }).then(url => {
              console.log('Test file URL:', url);
              // Clean up test file
              return testRef.delete();
            }).then(() => {
              console.log('Test file cleaned up');
            }).catch(error => {
              console.error('Firebase Storage test failed:', error);
            });
          } catch (error) {
            console.error('Firebase Storage test error:', error);
          }
        } else {
          console.warn('Firebase Storage not available for testing');
        }
      }, 2000);
    });
  </script>
</body>
</html> 